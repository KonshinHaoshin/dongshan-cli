name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        shell: pwsh
        run: cargo build --release

      - name: Prepare dist assets
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force dist | Out-Null
          Copy-Item target\release\dongshan.exe dist\dongshan.exe -Force
          Compress-Archive -Path dist\dongshan.exe -DestinationPath dist\dongshan-windows-x86_64.zip -Force

      - name: Install Inno Setup
        shell: pwsh
        run: choco install innosetup --no-progress -y

      - name: Build setup installer
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          $exe = (Resolve-Path "target\release\dongshan.exe").Path
          & "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe" `
            "packaging\windows\dongshan.iss" `
            "/DMyAppVersion=$version" `
            "/DMyAppExe=$exe" `
            "/Odist" `
            "/Fdongshan-setup-windows-x86_64"

      - name: Generate checksums
        shell: pwsh
        run: |
          Get-FileHash dist\dongshan-windows-x86_64.zip -Algorithm SHA256 | ForEach-Object { "$($_.Hash)  dongshan-windows-x86_64.zip" } | Set-Content dist\SHA256SUMS.txt
          Get-FileHash dist\dongshan-setup-windows-x86_64.exe -Algorithm SHA256 | ForEach-Object { "$($_.Hash)  dongshan-setup-windows-x86_64.exe" } | Add-Content dist\SHA256SUMS.txt

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/dongshan-windows-x86_64.zip
            dist/dongshan-setup-windows-x86_64.exe
            dist/SHA256SUMS.txt
          generate_release_notes: true
